<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI Walkthrough</title>

    <!-- Include the Tailwind CSS CDN link -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

    <!-- Assets -->
    <link rel="stylesheet" href="assets/upload.css">

    <!-- Configuration -->
    <script>
        // Configurer: Ignore this block
        var STARTING = {
            SPLASH_SCREEN: 0,
            NO_SPLASH_SCREEN: 1
        }

        // Configurer: Configure here
        var startingMode = STARTING.NO_SPLASH_SCREEN;
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>
</head>

<body>
    <div id="splash-screen" class="bg-gray-100 h-screen flex justify-center relative hidden">
        <!-- Positioned at 33% from the top -->
        <div class="text-center absolute top-1/3 transform -translate-y-1/3">
            <!-- First liner -->
            <div class="text-9xl" id="first-text">
                UI Walkthrough
            </div>

            <!-- Second liner -->
            <div class="text-6xl mt-4" id="second-text">
                Authoring Tool
            </div>
        </div>

        <div class="w-full bg-gray-200 mx-auto rounded-lg overflow-hidden border border-gray-300 absolute bottom-0 left-0">
            <div id="progress-bar-splash" class="progress-bar bg-green-500 text-xs leading-none py-1" data-loading-ai style="width:0;"></div>
        </div>
    </div>

    <div id="upload-screen" class="bg-gray-100 h-screen flex justify-center relative hidden">
        <!-- Positioned at 33% from the top -->
        <div class="text-center absolute top-1/3 transform -translate-y-1/3">
            <div>
                <label class="text-4xl" for="files">Upload images from your device:</label>
                <br/><br/>
                <input id="files" type="file" multiple="multiple" accept="image/jpeg, image/png, image/jpg">
            </div>
        </div>
    </div>

    <div id="author-screen" class="bg-gray-100 h-screen flex justify-center relative hidden">
        <style id="output-2">
              .thumbnail-container {
                    position: relative;
                    display: inline-block;
                }

                .thumbnail {
                    width: 100%;
                    height: auto;
                    cursor: pointer;  /* To indicate the image is clickable */
                }

                .thumbnail-container .close-icon {
                    position: absolute;
                    top: 5px;
                    right: 5px;
                    background-color: rgba(255, 255, 255, 0.8);
                    border-radius: 50%;
                    cursor: pointer;
                    font-weight: bold;
                    z-index: 10;
                    width: 25px;
                    height: 25px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }
                .thumbnail-container .caption-icon {
                    position: absolute;
                    top: 38px;
                    right: 5px;
                    background-color: rgba(255, 255, 255, 0.8);
                    border-radius: 50%;
                    cursor: pointer;
                    font-weight: bold;
                    z-index: 10;
                    font-size: 90%;
                    width: 25px;
                    height: 25px;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                }

                .thumbnail-caption.overlay {
                    position: absolute;
                }
                .thumbnail-caption {
                    top: 0;
                    width: 100%;
                    background-color: rgba(0, 0, 0, 0.8); /* semi-transparent black */
                    color: white;
                    padding: 5px;
                    text-align: center;
                    overflow: hidden;
                    white-space: nowrap;
                    text-overflow: ellipsis;
                    z-index: 9;
                    padding: 22px 0;
                }
                .thumbnail-caption:empty {
                    display: none;
                }
        </style>
        <output id="result"></output>
    </div>

    <script>
        function loadSplashScreen(cb) {
            document.getElementById("splash-screen").classList.remove("hidden");
            
            var countProgressSplash = 0;
            var intervProgressSplash = setInterval(()=>{
                if(countProgressSplash===3) {
                    clearInterval(intervProgressSplash)
                    document.getElementById("splash-screen").classList.add("hidden");
                    if(cb) cb();
                }
                document.getElementById("progress-bar-splash").style.width = (parseInt(document.getElementById("progress-bar-splash").style.width) + 46) + "%";
                countProgressSplash++
            }, 1000)
        } // loadSplashScreen
        
        function loadUploadScreen() {
            document.getElementById("splash-screen").classList.add("hidden");
            document.getElementById("upload-screen").classList.remove("hidden");
        }

        function cancelAuthorScreen() {
            document.querySelector("#files").value = ""
            const output = document.querySelector("#result");
            if (confirm("Cancel screen?")) {
                output.removeChild(div);
                loadUploadScreen();
            }
            const captionDiv = document.querySelector(".thumbnail-caption");
            captionDiv.classList.remove("hidden");
        }

        function loadAuthorScreen() {
            document.getElementById("upload-screen").classList.add("hidden");
            document.getElementById("author-screen").classList.remove("hidden");
        }
        
        if(startingMode === STARTING.SPLASH_SCREEN)
            loadSplashScreen(loadUploadScreen);
        else
            loadUploadScreen();

        // TODO:
        function getUserID() {
            return "TestUser1";
        } // getUserID
    </script>

    <script>
        document.querySelector("#files").addEventListener("change", (e) => {
        if(document.querySelector("#files").value === "") return;
        if (window.File && window.FileReader && window.FileList && window.Blob) {
            loadAuthorScreen();
          const files = e.target.files;
          const output = document.querySelector("#result");
          for (let i = 0; i < files.length; i++) {
            if (!files[i].type.match("image")) continue;
            const picReader = new FileReader();
            picReader.addEventListener("load", function (event) {
              const picFile = event.target;
              window.div = document.createElement("div");
              div.className = "thumbnail-container";
              div.innerHTML = `
                <div class="thumbnail-caption overlay" onclick="event.target.classList.toggle('overlay');"></div>
                <img class="thumbnail" src="${picFile.result}" title="${picFile?.name?picFile.name:'Screen'}"/>
                <span class="close-icon" title="Remove">&times;</span>
                <span class="caption-icon" title="Caption">&copy;</span>
              `;
              output.appendChild(div);
      
              // Add click event for canceling screen
              document.body.querySelector(".close-icon").addEventListener("click", cancelAuthorScreen);

              // Add click event for caption
              document.body.querySelector(".caption-icon").addEventListener("click", function() {
                const caption = prompt("Want to add instructions?");
                const captionDiv = document.querySelector(".thumbnail-caption");
                if (caption) {
                    captionDiv.innerText = caption;
                    captionDiv.classList.remove("hidden");
                } else if (caption === "") {
                    captionDiv.innerText = "";
                    captionDiv.classList.add("hidden");
                }
              });
            });

            // Triggers load event
            picReader.readAsDataURL(files[i]);
          }
        } else {
          alert("Your browser does not support File API");
        }
      });
    </script>

    <script>
        const haveShapes = false;
        document.addEventListener('keydown', function(event) {
            // Using the `key` property (preferred way)
            if (event?.key === 'Escape' || event?.key === 'Esc' || event?.keyCode === 27) {
                if(!haveShapes)
                    cancelAuthorScreen();
            } else if (event?.key === 'Enter' || event?.keyCode === 13) {
                outputHTML();
            }
        });

        function outputHTML() {
            //TODO: Erase `<span class="close-icon" title="Remove">Ã—</span>`
            var style = document.createElement("style");
            style.innerHTML = document.getElementById("output-2").innerHTML;

            var result = document.createElement("div");
            result.innerHTML = document.getElementById("result").innerHTML;
            result.querySelector(".thumbnail-caption").removeAttribute("onclick");

            console.log({style, result});
            // console.log({style:style.innerHTML, result:result.innerHTML});
        } // outputHTML

    </script>


<button id="finishPolygon">Finish Polygon</button>
<script>
let canvas = new fabric.Canvas('canvas');
let polygonPoints = [];
let isDrawing = false;

document.getElementById('files').addEventListener('change', function (e) {
    const file = e.target.files[0];
    const reader = new FileReader();

    reader.onload = function (f) {
        fabric.Image.fromURL(f.target.result, function (img) {
            // Clear existing polygons or any other objects from the canvas
            canvas.getObjects().forEach(function(object) {
                canvas.remove(object);
            });
            // Reset the polygonPoints array
            polygonPoints = [];
            isDrawing = false;

            // Set the new background image
            img.set({ left: 0, top: 0, scaleX: (canvas.width / img.width), scaleY: (canvas.height / img.height) });
            canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {});
        });
    };

    if (file) {
        reader.readAsDataURL(file);
    }
});

canvas.on('mouse:down', function(options) {
    if (!isDrawing) {
        isDrawing = true;
        polygonPoints.push(options.pointer);
    } else {
        polygonPoints.push(options.pointer);
        canvas.renderAll();
    }
});

canvas.on('mouse:up', function() {
    if (polygonPoints.length > 1) {
        const line = new fabric.Line([polygonPoints[polygonPoints.length - 2].x, polygonPoints[polygonPoints.length - 2].y, polygonPoints[polygonPoints.length - 1].x, polygonPoints[polygonPoints.length - 1].y], {
            stroke: 'red',
            strokeWidth: 2
        });
        canvas.add(line);
    }
});

document.getElementById('finishPolygon').addEventListener('click', function() {
    if (polygonPoints.length > 2) {
        const polygon = new fabric.Polygon(polygonPoints, {
            fill: 'rgba(255,0,0,0.3)',
            stroke: 'red',
            strokeWidth: 2
        });
        canvas.add(polygon);

        // Extract coordinates for image map
        const coordsArray = [];
        for (let point of polygonPoints) {
            coordsArray.push(Math.round(point.x) + ',' + Math.round(point.y));
        }

        // Generate the <area> element for the image map and log it to the console
        const areaElement = `<area shape="poly" coords="${coordsArray.join(', ')}" href="#" alt="Descriptive text">`;
        console.log(areaElement);

        polygonPoints = [];
        isDrawing = false;
    }
});

</script>

</body>

</html>
